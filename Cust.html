<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <title>個案管理系統</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body {
      background-color: #f8f9fa;
      font-family: "Microsoft JhengHei", Arial, sans-serif;
    }

    .container {
      max-width: 800px;
      margin-top: 20px;
      margin-bottom: 50px;
    }

    /* 隱藏區塊樣式 */
    .hidden-section {
      display: none;
    }

    .cust-label {
      font-weight: bold;
      font-size: 1.2rem;
      color: #0d6efd;
      padding: 5px 0;
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
  </style>
</head>

<body>

  <div id="loadingSpin" class="loading-overlay">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <nav class="navbar navbar-dark bg-primary sticky-top">
    <div class="container-fluid">
      <button class="btn btn-light text-primary" type="button" data-bs-toggle="offcanvas"
        data-bs-target="#offcanvasNavbar">
        <i class="fas fa-bars"></i>
      </button>
      <span class="navbar-brand mb-0 h1 mx-auto">個案管理系統</span>
    </div>
  </nav>

  <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasNavbar">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title">系統導航</h5>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
      <?!= includeNav(); ?>
    </div>
  </div>

  <div class="container">

    <div id="searchSection" class="card shadow-sm mb-4">
      <div class="card-body">
        <h5 class="card-title mb-3">個案選擇</h5>
        <div class="mb-3">
          <label for="selectCustName" class="form-label">請選擇個案姓名：</label>
          <select class="form-select" id="selectCustName">
            <option value="" disabled selected>載入中...</option>
          </select>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-primary flex-grow-1" id="btnQuery"><i class="fas fa-search"></i> 查詢</button>
          <button class="btn btn-success flex-grow-1" id="btnAddInit"><i class="fas fa-plus"></i> 新增</button>
        </div>
      </div>
    </div>

    <div id="detailSection" class="card shadow-sm hidden-section">
      <div class="card-header bg-light">
        <h5 class="mb-0">個案詳細資料</h5>
      </div>
      <div class="card-body">
        <form id="custForm">
          <input type="hidden" id="formMode" value="update">

          <div class="mb-3">
            <label class="form-label">個案姓名 (Cust_N)</label>
            <div id="displayCustName" class="cust-label"></div>
            <input type="hidden" id="inputCustName">
          </div>

          <div class="row mb-3">
            <div class="col-md-4">
              <label for="inputCustSex" class="form-label">性別 (Cust_Sex)</label>
              <select class="form-select" id="inputCustSex">
                <option value="男" selected>男</option>
                <option value="女">女</option>
              </select>
            </div>
            <div class="col-md-8">
              <label for="inputCustBirth" class="form-label">個案生日 (Cust_BD)</label>
              <div class="input-group">
                <input type="date" class="form-control" id="inputCustBirth" required>
                <span class="input-group-text" id="displayAge">年齡：-- 歲</span>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label for="inputCustAddr" class="form-label">個案住址 (Cust_Add)</label>
            <input type="text" class="form-control" id="inputCustAddr">
          </div>

          <div class="mb-3">
            <label for="inputSupName" class="form-label">督導姓名 (Sup_N)</label>
            <input type="text" class="form-control" id="inputSupName">
          </div>

          <div class="mb-3">
            <label for="inputDSupName" class="form-label">副督導姓名 (DSup_N)</label>
            <input type="text" class="form-control" id="inputDSupName">
          </div>

          <div class="mb-3">
            <label for="inputSupTel" class="form-label">督導電話 (Sup_Tel)</label>
            <input type="text" class="form-control" id="inputSupTel" placeholder="0000000000">
          </div>

          <div class="mb-3">
            <label for="inputOfficeTel" class="form-label">公司電話 (Office_Tel)</label>
            <input type="text" class="form-control" id="inputOfficeTel">
          </div>

          <div class="mb-3">
            <label for="inputEcName" class="form-label">緊急聯絡人 (Cust_EC)</label>
            <input type="text" class="form-control" id="inputEcName">
          </div>

          <div class="mb-3">
            <label for="inputEcTel" class="form-label">緊急聯絡人電話 (Cust_EC_Tel)</label>
            <input type="text" class="form-control" id="inputEcTel" placeholder="0000000000">
          </div>

          <div class="mb-3">
            <label for="inputLtcCode" class="form-label">服務項目 (Cust_LTC_Code)</label>
            <textarea class="form-control" id="inputLtcCode" rows="5" placeholder="請輸入服務項目以 ',' 分開"></textarea>
          </div>

          <div class="d-grid gap-2 d-md-flex justify-content-md-center mt-4">
            <button type="button" class="btn btn-primary" id="btnSave">
              <i class="fas fa-save"></i> 更新資料
            </button>
            <button type="button" class="btn btn-danger" id="btnDelete">
              <i class="fas fa-trash-alt"></i> 刪除
            </button>

            <button type="button" class="btn btn-outline-dark" id="btnBack">返回搜尋</button>
          </div>
        </form>
      </div>
    </div>

    <div class="container mt-2 text-end">
      <small class="text-muted">
        <i class="fas fa-user-circle"></i> 當前管理員：
        <?= userEmail ?>
      </small>
    </div>

  </div>

  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    $(document).ready(function () {
      $('#loadingSpin').css('display', 'flex');
      // 頁面載入時，先抓取下拉選單資料
      loadDropdown();

      // 當生日欄位數值改變時，自動更新年齡標註
      $('#inputCustBirth').on('change', function () {
        updateAgeDisplay($(this).val());
      });

      // 查詢按鈕事件
      $('#btnQuery').click(function () {
        const selectedName = $('#selectCustName').val();
        if (!selectedName) {
          Swal.fire('提示', '請先選擇一位個案', 'warning');
          return;
        }
        $('#loadingSpin').show();

        google.script.run.withSuccessHandler(function (response) {
          $('#loadingSpin').hide();
          if (response.found) {
            populateForm(response.rowResult);
            switchToDetailMode('update');
          } else {
            Swal.fire('錯誤', '找不到該個案資料', 'error');
          }
        }).queryCustData(selectedName);
      });

      // 新增按鈕事件 (初始畫面)
      $('#btnAddInit').click(function () {
        // 彈出對話框詢問新個案姓名
        Swal.fire({
          title: '請輸入新個案姓名',
          input: 'text',
          showCancelButton: true,
          confirmButtonText: '確定',
          cancelButtonText: '取消',
          inputValidator: (value) => {
            if (!value) {
              return '姓名不能為空！';
            }
          }
        }).then((result) => {
          if (result.isConfirmed) {
            const newName = result.value;
            // 清空表單並填入姓名
            clearForm();
            $('#displayCustName').text(newName);
            $('#inputCustName').val(newName);
            switchToDetailMode('add');
          }
        });
      });

      // 儲存/更新按鈕事件
      $('#btnSave').click(function () {
        const mode = $('#formMode').val();
        const formData = {
          custName: $('#inputCustName').val(),
          custSex: $('#inputCustSex').val(),
          custBirth: $('#inputCustBirth').val(),
          custAddr: $('#inputCustAddr').val(),
          supName: $('#inputSupName').val(),
          dsupName: $('#inputDSupName').val(),
          supTel: $('#inputSupTel').val(),
          officeTel: $('#inputOfficeTel').val(),
          ecName: $('#inputEcName').val(),
          ecTel: $('#inputEcTel').val(),
          ltcCode: $('#inputLtcCode').val()
        };

        if (!formData.custBirth) {
          Swal.fire('提示', '請輸入生日', 'warning');
          return;
        }

        $('#loadingSpin').show();

        if (mode === 'add') {
          // 新增模式
          google.script.run.withSuccessHandler(function (res) {
            $('#loadingSpin').hide();
            if (res.success) {
              Swal.fire({
                title: '成功',
                text: res.message,
                icon: 'success',
                confirmButtonText: '確定'
              }).then(() => {
                // 新增後「重新整理頁面」以載入新的下拉清單並回到初始狀態
                backToSearch();
              });
            } else {
              Swal.fire('失敗', res.message, 'error');
            }
          }).addCustData(formData);
        } else {
          // 更新模式
          google.script.run.withSuccessHandler(function (res) {
            $('#loadingSpin').hide();
            if (res.success) {
              Swal.fire({
                title: '更新成功',
                text: res.message,
                icon: 'success',
                confirmButtonText: '確定'
              }).then(() => {
                // 更新後「回到查詢頁面」而不是重整，這樣速度較快
                // 也可以選擇用 window.location.reload();
                backToSearch();
              });
            } else {
              Swal.fire('失敗', res.message, 'error');
            }
          }).updateCustData(formData);
        }
      });



      // 刪除按鈕事件
      $('#btnDelete').click(function () {
        const custName = $('#inputCustName').val();
        Swal.fire({
          title: '確定刪除?',
          text: `將刪除個案：${custName} 的所有資料，此動作無法復原！`,
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',
          confirmButtonText: '是的，刪除',
          cancelButtonText: '取消'
        }).then((result) => {
          if (result.isConfirmed) {
            $('#loadingSpin').show();
            google.script.run.withSuccessHandler(function (res) {
              $('#loadingSpin').hide();
              if (res.success) {
                Swal.fire('已刪除', res.message, 'success').then(
                  () => { backToSearch(); });
              } else {
                Swal.fire('錯誤', res.message, 'error');
              }
            }).deleteCustData(custName);
          }
        });
      });
      $('#btnBack').click(function () {
        $('#detailSection').hide();   // 隱藏詳細資料表單
        $('#searchSection').show();   // 顯示查詢與新增區塊
      });
      $('#loadingSpin').hide();
    });

    //

    // 載入下拉選單
    function loadDropdown() {
      google.script.run.withSuccessHandler(function (list) {
        const select = $('#selectCustName');
        select.empty();
        select.append('<option value="" disabled selected>請選擇個案...</option>');
        if (list.length === 0) {
          select.append('<option value="" disabled>無資料</option>');
        } else {
          list.forEach(function (name) {
            select.append(`<option value="${name}">${name}</option>`);
          });
        }
      }).getCustList();
    }

    // 切換顯示模式 (add/update)
    function switchToDetailMode(mode) {
      $('#searchSection').hide(); // 隱藏查詢區塊 
      $('#detailSection').show(); // 顯示編輯區塊 
      $('#formMode').val(mode);

      if (mode === 'add') {
        $('#btnSave').html('<i class="fas fa-save"></i> 新增資料');
        $('#btnDelete').hide(); // 新增模式不顯示刪除鈕
      } else {
        $('#btnSave').html('<i class="fas fa-sync"></i> 更新'); // 更新鈕 
        $('#btnDelete').show(); // 刪除鈕 
      }
    }

    // 填入表單資料
    function populateForm(data) {
      $('#displayCustName').text(data.Cust_N); // 以標籤顯示 
      $('#inputCustName').val(data.Cust_N);
      $('#inputCustSex').val(data.Cust_Sex);
      $('#inputCustBirth').val(data.Cust_BD);
      // 填入資料後立即計算年齡
      updateAgeDisplay(data.Cust_BD);
      $('#inputCustAddr').val(data.Cust_Add);
      $('#inputSupName').val(data.Sup_N);
      $('#inputDSupName').val(data.DSup_N);
      $('#inputSupTel').val(data.Sup_Tel);
      $('#inputOfficeTel').val(data.Office_Tel);
      $('#inputEcName').val(data.Cust_EC);
      $('#inputEcTel').val(data.Cust_EC_Tel);
      $('#inputLtcCode').val(data.Cust_LTC_Code);
    }

    // 清空表單
    function clearForm() {
      $('#custForm')[0].reset();
      $('#displayCustName').text('');
      $('#inputCustName').val('');
    }

    // 計算年齡的函式
    function calculateAge(birthDateString) {
      if (!birthDateString) return "--";
      const today = new Date();
      const birthDate = new Date(birthDateString);
      let age = today.getFullYear() - birthDate.getFullYear();
      const m = today.getMonth() - birthDate.getMonth();
      // 如果今天日期還沒到生日的月份，或到了月份但還沒到當天，年齡減 1
      if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
        age--;
      }
      return age >= 0 ? age : 0;
    }

    // 更新畫面上的年齡顯示
    function updateAgeDisplay(birthDate) {
      const age = calculateAge(birthDate);
      $('#displayAge').text(`年齡：${age} 歲`);
    }

    // 新增一個輔助函式：回到查詢初始狀態
    function backToSearch() {
      $('#detailSection').hide();   // 隱藏詳細資料表單
      $('#searchSection').show();   // 顯示查詢與新增區塊
      clearForm();                  // 清空表單內容
      loadDropdown();               // 重新整理下拉選單（確保資料同步）
    }
       
  </script>
</body>
<?!= includeFooter(); ?>

</html>