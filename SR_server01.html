<!DOCTYPE html>
<html>

<head>
  <base target="_top" />
  <title>舒漾電子服務紀錄管理(用戶端)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    body {
      background-color: #fff5f5;
      font-family: "Microsoft JhengHei", sans-serif;
      padding: 20px;
    }

    .container {
      max-width: 700px;
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      margin: auto;
    }

    .loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }

    .label-value {
      font-weight: bold;
      color: #d63384;
      font-size: 1.1rem;
      padding: 5px 10px;
      background: #f8f9fa;
      border-radius: 5px;
      display: inline-block;
      min-width: 100px;
    }

    .hidden-section {
      display: none;
    }

    .section-title {
      border-left: 5px solid #dc3545;
      padding-left: 10px;
      margin-bottom: 20px;
      color: #dc3545;
    }
  </style>
</head>

<body>
  <div id="loadingSpin" class="loading">
    <div class="spinner-border text-danger"></div>
  </div>

  <div class="container">
    <h2 class="text-center text-danger mb-4">舒漾電子服務紀錄管理(用戶端)</h2>

    <div id="searchSection">
      <div class="mb-3">
        <label class="form-label">登入 E-mail</label>
        <div class="input-group">
          <input type="email" class="form-control" id="currentUserEmail" readonly />
        </div>
        <a href="https://accounts.google.com/AccountChooser?continue=<?= getScriptUrl() ?>" target="_top"
          class="btn btn-outline-danger">
          更換 Email 登入
        </a>
      </div>

      <h5 class="section-title">查詢條件</h5>
      <div class="row">
        <div class="col-md-6 mb-3">
          <label class="form-label">日期 (Date)</label>
          <input type="date" class="form-control" id="queryDate" />
        </div>
        <div class="col-md-6 mb-3">
          <label class="form-label">入場別 (SRTimes)</label>
          <select class="form-select" id="querySRTimes">
            <option value="1" selected>第一次</option>
            <option value="2">第二次</option>
            <option value="3">第三次</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6 mb-3">
          <label class="form-label">居服員姓名 (User_N)</label>
          <select class="form-select" id="queryUserN">
            <option value="" disabled selected>系統載入中...</option>
          </select>
        </div>
        <div class="col-md-6 mb-3">
          <label class="form-label">個案姓名 (Cust_N)</label>
          <select class="form-select" id="queryCustN">
            <option value="" disabled selected>請先選擇居服員...</option>
          </select>
        </div>
      </div>
      <div class="row" id="otherCustRow">
        <div class="col-md-12 mb-3">
          <label class="form-label">其他個案名單 (若常用名單無此個案，請由在此選擇)</label>
          <select class="form-select" id="queryCustNOther" disabled>
            <option value="" selected>-- 請先從上方選擇「其他」 --</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6 mb-3">
          <label class="form-label">服務編碼 (Pay_Type)</label>
          <select class="form-select" id="queryPType">
            <option value="補助" selected>補助</option>
            <option value="自費">自費</option>
          </select>
        </div>

        <div class="col-md-6 mb-3">
          <label class="form-label">服務編碼 (SR_ID)</label>
          <select class="form-select" id="querySrId">
            <option value="" disabled selected>請先選擇個案...</option>
          </select>
        </div>
      </div>

      <div class="d-grid gap-2 mt-3">
        <button class="btn btn-danger btn-lg" onclick="handleAction('query')">
          查詢紀錄
        </button>
      </div>
    </div>

    <div id="detailSection" class="hidden-section mt-4 border-top pt-4">
      <h5 class="section-title">紀錄內容</h5>
      <div class="row mb-3">
        <div class="col-12">
          <span id="labQuery" class="label-value fs-6" style="color:#cdb5f8;"></span>
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">服務紀錄內容 (SR_REC)</label>
        <textarea class="form-control" id="inputSrRec" rows="4" placeholder="請詳細輸入服務內容..."></textarea>
        <div class="mt-2 d-flex justify-content-end">
          <div class="btn-group shadow-sm" role="group">
            <button type="button" class="btn btn-sm btn-outline-secondary"
              onclick="handleClipboard('cut', '#inputSrRec')">
              <i class="fa-solid fa-scissors"></i> 剪下
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary"
              onclick="handleClipboard('copy', '#inputSrRec')">
              <i class="fa-regular fa-copy"></i> 複製
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary"
              onclick="handleClipboard('paste', '#inputSrRec')">
              <i class="fa-solid fa-paste"></i> 貼上
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary"
              onclick="handleClipboard('addAI', '#inputSrRec')">
              <i class="fa-solid fa-eraser"></i> AI
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-6 mb-3">
          <label class="form-label">意識狀況 (LOC)</label>
          <select class="form-select" id="inputLoc">
            <option value="清醒">清醒</option>
            <option value="混亂">混亂</option>
            <option value="木僵">木僵</option>
            <option value="嗜睡">嗜睡</option>
            <option value="昏迷">昏迷</option>
          </select>
        </div>
        <div class="col-md-6 mb-3">
          <label class="form-label">身心狀況 (Mood)</label>
          <select class="form-select" id="inputMood">
            <option value="穩定">穩定</option>
            <option value="不穩定">不穩定</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">特殊狀況說明及處理 (SPCONS)</label>
          <textarea class="form-control" id="inputSpcons" rows="2"></textarea>
        </div>
      </div>
      <div class="d-grid gap-2">
        <button class="btn btn-primary btn-lg" id="btnUpdate" onclick="handleAction('update')">
          更新紀錄
        </button>
        <button class="btn btn-success btn-lg" id="btnAdd" onclick="handleAction('add')">
          確認存檔
        </button>
        <button class="btn btn-secondary btn-lg" onclick="backToSearch()">
          返回查詢
        </button>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    // --- 全域變數：模擬 Session ---
    let GLOBAL_DATA = {
      users: [],      // SYCompany > User + SYTemp > User
      custs: [],      // SYCompany > Cust
      ltcCodes: [],   // SYCompany > LTC_Code
      currentUser: null,
      isNewBinding: false
    };

    $(document).ready(function () {
      $('#loadingSpin').css('display', 'flex').show();

      // --- 需求 8：日期前後只能 7 天 ---
      const today = new Date();
      const formatDate = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      };

      $("#queryDate").val(formatDate(today));
      const minDate = new Date(today); minDate.setDate(today.getDate() - 7);
      const maxDate = new Date(today); maxDate.setDate(today.getDate() + 7);
      $("#queryDate").attr("min", formatDate(minDate));
      $("#queryDate").attr("max", formatDate(maxDate));
      // ---------------------------------

      // 初始化：一次抓取所有資料
      google.script.run
        .withSuccessHandler(initSuccess)
        .withFailureHandler(function (err) {
          $("#loadingSpin").hide();
          Swal.fire("系統錯誤", "初始化失敗：" + err.message, "error");
        })
        .getSRServer01InitData();

      // --- 綁定事件監聽 ---
      $("#queryUserN").change(function () {
        const selectedUserName = $(this).val();
        updateCustSelect(selectedUserName);
      });

      $("#queryCustN").change(function () {
        if ($(this).val() === "其他") {
          $("#otherCustRow").show();
          $("#queryCustNOther").prop("disabled", false).focus();
        } else {
          $("#otherCustRow").hide();
          $("#queryCustNOther").prop("disabled", true).val("");
          updateSrIdSelect($(this).val());
        }
      });

      $("#queryCustNOther").change(function () {
        updateSrIdSelect($(this).val());
      });
    });

    // --- 初始化成功回調 ---
    function initSuccess(data) {
      $("#loadingSpin").hide();

      GLOBAL_DATA.users = data.users;
      GLOBAL_DATA.custs = data.custs;
      GLOBAL_DATA.ltcCodes = data.ltcCodes;

      $("#currentUserEmail").val(data.email);

      // 需求 4：比對 Email
      const matchedUser = GLOBAL_DATA.users.find(u => u.email === data.email);
      const $userSelect = $("#queryUserN");

      $userSelect.empty().append('<option value="" disabled selected>請選擇居服員...</option>');

      // 填入所有 User 到下拉選單 (這裡已包含從 Temp 更新過的名單)
      GLOBAL_DATA.users.forEach(u => {
        $userSelect.append(`<option value="${u.name}">${u.name}</option>`);
      });

      if (matchedUser) {
        GLOBAL_DATA.currentUser = matchedUser;
        GLOBAL_DATA.isNewBinding = false;
        $userSelect.val(matchedUser.name).prop("disabled", true);
        updateCustSelect(matchedUser.name);
      } else {
        GLOBAL_DATA.currentUser = null;
        GLOBAL_DATA.isNewBinding = true;
        $userSelect.prop("disabled", false);
      }
    }

    // --- 需求 5：更新 Cust 選單 ---
    function updateCustSelect(userName) {
      const $custSelect = $("#queryCustN");
      const $otherSelect = $("#queryCustNOther");

      $custSelect.empty().append('<option value="" disabled selected>請選擇個案...</option>');
      $otherSelect.empty().append('<option value="" disabled selected>請選擇其他個案...</option>');
      $("#querySrId").empty().append('<option value="" disabled selected>請先選擇個案...</option>');

      const userObj = GLOBAL_DATA.users.find(u => u.name === userName);
      let favCusts = [];

      if (userObj && userObj.favCustStr) {
        favCusts = userObj.favCustStr.split(',').map(s => s.trim()).filter(s => s !== "");
      }

      favCusts.forEach(c => {
        $custSelect.append(`<option value="${c}">${c}</option>`);
      });
      $custSelect.append('<option value="其他">其他 (開啟下方清單)</option>');

      const allCustNames = GLOBAL_DATA.custs.map(c => c.name);
      const otherCusts = allCustNames.filter(name => !favCusts.includes(name)).sort();

      otherCusts.forEach(c => {
        $otherSelect.append(`<option value="${c}">${c}</option>`);
      });
    }

    // --- 需求 6：更新 SR_ID 選單 ---
    function updateSrIdSelect(custName) {
      if (!custName) return;

      const $srSelect = $("#querySrId");
      $srSelect.empty().append('<option value="" disabled selected>請選擇服務編碼...</option>');

      const custObj = GLOBAL_DATA.custs.find(c => c.name === custName);
      let favCodes = [];

      if (custObj && custObj.ltcCodeStr) {
        favCodes = custObj.ltcCodeStr.split(',').map(s => s.trim()).filter(s => s !== "");
      }

      const favCodesSet = GLOBAL_DATA.ltcCodes.filter(srcode => favCodes.includes(srcode.id)).sort();
      const otherCodes = GLOBAL_DATA.ltcCodes.filter(srcode => !favCodes.includes(srcode.id)).sort();

      favCodesSet.forEach(srcode => {
        $srSelect.append(`<option value="${srcode.id}">${srcode.id}${srcode.cont}</option>`);
      });


      if (otherCodes.length > 0 && favCodes.length > 0) {
        $srSelect.append('<option disabled>──────────</option>');
      }

      otherCodes.forEach(srcode => {
        $srSelect.append(`<option value="${srcode.id}">${srcode.id}${srcode.cont}</option>`);
      });
    }

    function validateQuery() {
      if (
        !$("#queryDate").val() ||
        !$("#querySRTimes").val() ||
        !$("#queryUserN").val() ||
        !$("#queryCustN").val() ||
        !$("#queryPType").val() ||
        !$("#querySrId").val()
      ) {
        Swal.fire("提示", "請填齊：日期、個案、居服員與編碼", "warning");
        return false;
      }
      return true;
    }

    async function handleAction(type) {
      let selectedCust = $("#queryCustN").val();
      if (selectedCust === "其他") {
        selectedCust = $("#queryCustNOther").val();
        if (!selectedCust) {
          Swal.fire("提示", "請選擇其他個案姓名", "warning");
          return;
        }
      }

      if (!validateQuery()) return;

      const formObj = {
        date: $("#queryDate").val(),
        SRTimes: $("#querySRTimes").val(),
        email: $("#currentUserEmail").val(),
        userName: $("#queryUserN").val(),
        custName: selectedCust,
        payType: $("#queryPType").val(),
        srId: $("#querySrId").val(),
        srRec: $("#inputSrRec").val(),
        loc: $("#inputLoc").val(),
        mood: $("#inputMood").val(),
        spcons: $("#inputSpcons").val(),
        userTel: "",
        isNewBinding: false
      };

      let exSPCONS = await getSPCons(formObj);

      // --- 需求 7：新使用者電話詢問 ---
      if ((type === "add" || type === "update") && GLOBAL_DATA.isNewBinding) {
        const { value: tel } = await Swal.fire({
          title: "初次綁定資料",
          text: `系統檢測到此 Email 尚未綁定 "${formObj.userName}"，請輸入您的聯絡電話以完成綁定`,
          input: "text",
          inputLabel: "聯絡電話 (User_Tel)",
          inputPlaceholder: "例：0912345678",
          showCancelButton: true,
          inputValidator: (value) => {
            if (!value) return "電話號碼不能為空！";
          },
        });

        if (tel) {
          formObj.userTel = "'" + tel;
          formObj.isNewBinding = true; // 標記為新綁定，後端將更新至 SYTemp
        } else {
          return;
        }
      }

      $("#loadingSpin").show();

      google.script.run
        .withSuccessHandler(function (res) {
          $("#loadingSpin").hide();

          if (res.success && formObj.isNewBinding) {
            GLOBAL_DATA.isNewBinding = false;
            $("#queryUserN").prop("disabled", true);
            let u = GLOBAL_DATA.users.find(u => u.name === formObj.userName);
            if (u) {
              u.email = formObj.email;
            }
          }

          if (type === "query") {
            if (res.found) {
              fillQueryLabel(formObj);
              fillDetail(res.data);
              $("#inputSrRec").focus();
              $("#detailSection").show();
              $("#searchSection").hide();
              $("#btnAdd").hide();
              $("#btnUpdate").show();
            } else {
              Swal.fire({
                title: "查無此紀錄，是否要新增一筆紀錄並開始編輯？",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#d33",
                confirmButtonText: "是，新增紀錄",
                cancelButtonText: "否",
              }).then((result) => {
                if (result.isConfirmed) {
                  fillQueryLabel(formObj);
                  setTimeout(function () { $("#inputSrRec").val("").focus(); }, 50);
                  $("#inputLoc").val(exSPCONS.loc || "清醒");
                  $("#inputMood").val(exSPCONS.mood || "穩定");
                  $("#inputSpcons").val(exSPCONS.spcons || "無");
                  $("#detailSection").show();
                  $("#searchSection").hide();
                  $("#btnUpdate").hide();
                  $("#btnAdd").show();
                }
              });
            }
          } else {
            Swal.fire({
              icon: res.success ? "success" : "error",
              title: res.success ? "成功" : "失敗",
              text: res.message,
              timer: res.success ? 1500 : null,
            }).then(() => {
              if (res.success) backToSearch();
            });
          }
        })
        .processSR01Data(formObj, type);
    }

    function backToSearch() {
      $("#detailSection").hide();
      $("#searchSection").show();
    }

    function fillQueryLabel(formObj) {
      const labelText = `${formObj.date}| ${formObj.SRTimes} | ${formObj.userName} | ${formObj.custName} | ${formObj.payType} | ${formObj.srId}`;
      $('#labQuery').text(labelText);
    }

    function fillDetail(data) {
      $('#inputSrRec').val(data.srRec || "");
      $('#inputLoc').val(data.loc || "清醒");
      $('#inputMood').val(data.mood || "穩定");
      $('#inputSpcons').val(data.spcons || "無");
    }

    async function handleClipboard(action, targetId) {
      const $el = $(targetId);
      const text = $el.val();
      const srid = GLOBAL_DATA.ltcCodes.find(x => String(x.id) === $('#querySrId').val().trim());
      try {
        if (action === 'cut') {
          if (!text) return showToast('info', '沒有內容可以剪下');
          await navigator.clipboard.writeText(text);
          $el.val("");
          showToast('success', '已剪下');
        } else if (action === 'copy') {
          if (!text) return showToast('info', '內容為空，無法複製');
          await navigator.clipboard.writeText(text);
          showToast('success', '已複製');
        } else if (action === 'paste') {
          const clipboardText = await navigator.clipboard.readText();
          if (!clipboardText) return showToast('info', '剪貼簿中沒有內容');
          const currentVal = $el.val();
          $el.val(currentVal + clipboardText);
          showToast('success', '已貼上');
        } else if (action === 'addAI') {
          const currentVal = $el.val();
          $el.val(`${currentVal}\n修飾以上句子，符合長照 ${srid.id}${srid.cont} 電子服務紀錄單的格式，50個字以內，內容不包含長照編碼。`);
          showToast('success', '已加入AI助手');
        }
      } catch (err) {
        console.error('剪貼簿操作失敗:', err);
        Swal.fire({ icon: 'error', title: '操作失敗', text: '請確保使用 HTTPS 並授權瀏覽器存取剪貼簿。' });
      }
    }

    function showToast(icon, title) {
      Swal.fire({
        icon: icon,
        title: title,
        timer: 1000,
        showConfirmButton: false,
        toast: true,
        position: 'top-end'
      });
    }

    function getSPCons(formObj) {
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(function (res) {
            if (res && res.data) {
              resolve(res.data);
            } else {
              resolve({ loc: "清醒", mood: "穩定", spcons: "無" });
            }
          })
          .withFailureHandler(function (err) {
            resolve({ loc: "清醒", mood: "穩定", spcons: "無" });
          })
          .getSPCONS(formObj);
      });
    }
  </script>
</body>
<?!= includeFooter(); ?>

</html>