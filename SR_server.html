<!DOCTYPE html>
<html>

<head>
  <base target="_top" />
  <title>舒漾電子服務紀錄管理(管理端)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    body {
      background-color: #fff5f5;
      font-family: "Microsoft JhengHei", sans-serif;
      padding: 20px;
    }

    .container {
      max-width: 700px;
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      margin: auto;
    }

    .loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }

    .label-value {
      font-weight: bold;
      color: #d63384;
      font-size: 1.1rem;
      padding: 5px 10px;
      background: #f8f9fa;
      border-radius: 5px;
      display: inline-block;
      min-width: 100px;
    }

    .hidden-section {
      display: none;
    }

    .section-title {
      border-left: 5px solid #dc3545;
      padding-left: 10px;
      margin-bottom: 20px;
      color: #dc3545;
    }
  </style>
</head>

<body>
  <div id="loadingSpin" class="loading">
    <div class="spinner-border text-danger"></div>
  </div>

  <nav class="navbar navbar-dark bg-danger sticky-top">
    <div class="container-fluid">
      <button class="btn btn-light text-danger" type="button" data-bs-toggle="offcanvas"
        data-bs-target="#offcanvasNavbar">
        <i class="fas fa-bars"></i>
      </button>
      <span class="navbar-brand mb-0 h1 mx-auto">電子服務紀錄管理(管理端)</span>
    </div>
  </nav>

  <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasNavbar">
    <div class="offcanvas-header">
      <h5>系統導航</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
      <?!= includeNav(); ?>
    </div>
  </div>

  <div class="container">
    <div id="searchSection">

      <h5 class="section-title">查詢條件</h5>
      <div class="row">
        <div class="col-md-6 mb-3">
          <label class="form-label">日期 (Date)</label>
          <input type="date" class="form-control" id="queryDate" />
        </div>
        <div class="col-md-6 mb-3">
          <label class="form-label">入場別 (SRTimes)</label>
          <select class="form-select" id="querySRTimes">
            <option value="1" selected>第一次</option>
            <option value="2">第二次</option>
            <option value="3">第三次</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="col-md-4 mb-3">
          <label class="form-label">居服員姓名 (User_N)</label>
          <select class="form-select" id="queryUserN">
            <option value="" selected>系統載入中...</option>
          </select>
        </div>
        <div class="col-md-8 mb-3">
          <label class="form-label">居服員 Email </label>
          <input type="email" class="form-control" id="queryUserEmail" readonly placeholder="請選擇居服員..." />
        </div>

      </div>
      <div class="row">
        <div class="col-md-4 mb-3">
          <label class="form-label">個案姓名 (Cust_N)</label>
          <select class="form-select" id="queryCustN">
            <option value="" selected>請先選擇居服員...</option>
          </select>
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label">服務編碼 (Pay_Type)</label>
          <select class="form-select" id="queryPayType">
            <option value="補助" selected>補助</option>
            <option value="自費">自費</option>
          </select>
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label">服務編碼 (SR_ID)</label>
          <select class="form-select" id="querySrId">
            <option value="" selected>請先選擇個案...</option>
          </select>
        </div>
      </div>

      <div class="d-grid gap-2 mt-3">
        <button class="btn btn-danger btn-lg" id="btnSearch" onclick="handleAction('query')">
          查詢紀錄
        </button>
      </div>
    </div>

    <div id="detailSection" class="hidden-section mt-4 border-top pt-4">
      <h5 class="section-title">紀錄內容</h5>
      <div class="row mb-3">
        <div class="col-12">
          <span id="labQuery" class="label-value fs-6" style="color:#cdb5f8;"></span>
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">服務紀錄內容 (SR_REC)</label>
        <textarea class="form-control" id="inputSrRec" rows="4" placeholder="請詳細輸入服務內容..."></textarea>
        <div class="mt-2 d-flex justify-content-end">
          <div class="btn-group shadow-sm" role="group">
            <button type="button" class="btn btn-sm btn-outline-secondary"
              onclick="handleClipboard('cut', '#inputSrRec')">
              <i class="fa-solid fa-scissors"></i> 剪下
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary"
              onclick="handleClipboard('copy', '#inputSrRec')">
              <i class="fa-regular fa-copy"></i> 複製
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary"
              onclick="handleClipboard('paste', '#inputSrRec')">
              <i class="fa-solid fa-paste"></i> 貼上
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary"
              onclick="handleClipboard('addAI', '#inputSrRec')">
              <i class="fa-solid fa-eraser"></i> AI
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6 mb-3">
          <label class="form-label">意識狀況 (LOC)</label>
          <select class="form-select" id="inputLoc">
            <option value="清醒">清醒</option>
            <option value="混亂">混亂</option>
            <option value="木僵">木僵</option>
            <option value="嗜睡">嗜睡</option>
            <option value="昏迷">昏迷</option>
          </select>
        </div>
        <div class="col-md-6 mb-3">
          <label class="form-label">身心狀況 (Mood)</label>
          <select class="form-select" id="inputMood">
            <option value="穩定">穩定</option>
            <option value="不穩定">不穩定</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">特殊狀況說明及處理 (SPCONS)</label>
          <textarea class="form-control" id="inputSpcons" rows="2"></textarea>
        </div>
      </div>
      <div class="d-grid gap-2">
        <button class="btn btn-primary btn-lg" id="btnUpdate" onclick="handleAction('update')">
          更新紀錄
        </button>
        <button class="btn btn-success btn-lg" id="btnAdd" onclick="handleAction('add')">
          確認存檔
        </button>
        <button class="btn btn-danger btn-lg" id="btnDelete" onclick="handleAction('delete')">
          刪除
        </button>
        <button class="btn btn-secondary btn-lg" id="btnBack" onclick="backToSearch()">
          返回查詢
        </button>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    // 定義前端 Session 資料結構
    let GLOBAL_DATA = {
      users: [],      // 存放 {name, email, custStr}
      custs: [],      // 存放 {name, ltcStr}
      ltcCodes: []    // 存放所有 SR_ID 字串
    };

    $(document).ready(function () {
      // 1. 設定預設日期為今天
      const now = new Date();
      const day = ("0" + now.getDate()).slice(-2);
      const month = ("0" + (now.getMonth() + 1)).slice(-2);
      const today = now.getFullYear() + "-" + (month) + "-" + (day);
      $('#queryDate').val(today);

      console.log("舒漾長照系統 - SR_server 頁面載入完成");

      // 2. 初始化頁面資料
      initPage();

      // 3. 綁定事件：居服員選擇變更
      $('#queryUserN').on('change', function () {
        const userName = $(this).val();
        handleUserChange(userName);
      });

      // 4. 綁定事件：個案選擇變更
      $('#queryCustN').on('change', function () {
        const custName = $(this).val();
        handleCustChange(custName);
      });

    });

    /**
     * 載入選單與初始化資料 (Session 存取)
     */
    function initPage() {
      $('#loadingSpin').css('display', 'flex');

      google.script.run
        .withSuccessHandler(function (data) {
          // 儲存至全域變數 (前端 Session)
          GLOBAL_DATA.users = data.users;
          GLOBAL_DATA.custs = data.custs;
          GLOBAL_DATA.ltcCodes = data.ltcCodes;

          // 填充居服員下拉選單
          const $userN = $('#queryUserN').empty().append('<option value="" disabled selected>請選擇居服員</option>');
          GLOBAL_DATA.users.forEach(u => {
            $userN.append(new Option(u.name, u.name));
          });

          // 初始化其他下拉選單
          $('#queryCustN').empty().append('<option value="" selected>請先選擇居服員</option>');
          $('#querySrId').empty().append('<option value="" selected>請先選擇個案</option>');

          $('#loadingSpin').hide();
        })
        .withFailureHandler(function (err) {
          $('#loadingSpin').hide();
          Swal.fire("系統錯誤", "初始化資料失敗: " + err.message, "error");
        })
        .getSRServerInitData();
    }

    /**
     * 處理居服員變更邏輯 (需求 4 & 5)
     */
    function handleUserChange(userName) {
      if (!userName) return;

      // 1. 找出該 User 的資料
      const userObj = GLOBAL_DATA.users.find(u => u.name === userName);
      if (!userObj) return;

      // 需求 4: 填入 Email
      $('#queryUserEmail').val(userObj.email || "");

      // 需求 5: 處理個案清單 (Cust_N)
      const $custSelect = $('#queryCustN').empty().append('<option value="" disabled selected>請選擇個案</option>');

      // A. 優先名單：來自 User > Cust_N
      let priorityCusts = [];
      if (userObj.custStr) {
        priorityCusts = userObj.custStr.split(',').map(s => s.trim()).filter(s => s !== "");
      }

      // B. 其餘名單：Session(Cust) - 優先名單 (不重複)
      const allCustNames = GLOBAL_DATA.custs.map(c => c.name);
      const otherCusts = allCustNames.filter(name => !priorityCusts.includes(name)).sort();

      // C. 依序填入
      priorityCusts.forEach(c => $custSelect.append(new Option(c, c)));

      if (priorityCusts.length > 0 && otherCusts.length > 0) {
        $custSelect.append('<option disabled>──────────</option>');
      }

      otherCusts.forEach(c => $custSelect.append(new Option(c, c)));

      // 重置下一級 SR_ID
      $('#querySrId').empty().append('<option value="" selected>請先選擇個案</option>');
    }

    /**
     * 處理個案變更邏輯 (需求 6)
     */
    function handleCustChange(custName) {
      if (!custName || custName.includes("──")) return; // 避免選到分隔線

      const $srSelect = $('#querySrId').empty().append('<option value="" disabled selected>請選擇服務編碼</option>');

      // 1. 找出該 Cust 的資料
      const custObj = GLOBAL_DATA.custs.find(c => c.name === custName);

      // A. 優先代碼：來自 Cust > LTC_Code
      let priorityCodes = [];
      if (custObj && custObj.ltcStr) {
        priorityCodes = custObj.ltcStr.split(',').map(s => s.trim()).filter(s => s !== "");
      }

      // B. 其餘代碼：Session(LTC_Code) - 優先代碼 (不重複)
      const allCodes = GLOBAL_DATA.ltcCodes;
      const favorCodes = allCodes.filter(srcode => priorityCodes.includes(srcode.id)).sort();
      const otherCodes = allCodes.filter(srcode => !priorityCodes.includes(srcode.id)).sort();

      // C. 依序填入
      favorCodes.forEach(srcode => {
        $srSelect.append(`<option value="${srcode.id}">${srcode.id}${srcode.cont}</option>`);
      });

      if (priorityCodes.length > 0 && otherCodes.length > 0) {
        $srSelect.append('<option disabled>──────────</option>');
      }

      otherCodes.forEach(srcode => {
        $srSelect.append(`<option value="${srcode.id}">${srcode.id}${srcode.cont}</option>`);
      });

    }


    /**
     * 驗證查詢欄位
     */
    function validateQuery() {
      const date = $('#queryDate').val();
      const SRTimes = $('#querySRTimes').val();
      const email = $('#queryUserEmail').val();
      const custName = $('#queryCustN').val();
      const userName = $('#queryUserN').val();
      const payType = $('#queryPayType').val();
      const srId = $('#querySrId').val();
      if (!date || !custName || !SRTimes || !userName || !payType || !srId) {
        Swal.fire({
          title: "欄位不完整",
          text: "請確保所有查詢欄位皆已填寫",
          icon: "warning"
        });
        return false;
      }
      return true;
    }

    /**
     * 執行 新增/更新/查詢/刪除 (邏輯保持不變)
     */
    function handleAction(actionType) {
      if (!validateQuery()) return;
      const formObj = { ...getFormObj(), ...getDetailObj() };
      $('#loadingSpin').css('display', 'flex');

      google.script.run
        .withSuccessHandler(function (res) {
          $('#loadingSpin').hide();
          if (actionType === "query") {
            if (res.success) {
              fillQueryLabel(formObj);
              fillDetail(res.data);
              $("#inputSrRec").focus();
              $('#btnUpdate').show();
              $('#btnDelete').show(); // 顯示刪除按鈕
              $('#btnAdd').hide();
              $('#detailSection').fadeIn();
              $('#searchSection').fadeOut();
            } else {
              Swal.fire({
                title: "查無此紀錄",
                text: "是否要新增一筆紀錄並開始編輯？",
                icon: "question",
                showCancelButton: true,
                confirmButtonText: "是，新增紀錄",
                cancelButtonText: "否"
              }).then((res) => {
                if (res.isConfirmed) {
                  fillQueryLabel(formObj);
                  clearDetail();
                  setTimeout(function () { $("#inputSrRec").val("").focus(); }, 50);
                  $('#btnAdd').show();
                  $('#btnDelete').hide();
                  $('#btnUpdate').hide();
                  $('#searchSection').fadeOut();
                  $('#detailSection').fadeIn();
                }
              });
            }
          }
          else {
            Swal.fire({
              title: res.success ? "操作成功" : "操作失敗",
              text: res.message || "",
              icon: res.success ? "success" : "error",
              timer: res.success ? 1500 : null
            }).then(() => {
              if (res.success) {
                backToSearch();
              }
            });
          }
        })
        .processSRData(formObj, actionType);
    }

    /**
     * 工具：取得查詢欄位資料
     */
    function getFormObj() {
      return {
        date: $('#queryDate').val(),
        SRTimes: $('#querySRTimes').val(),
        custName: $('#queryCustN').val(),
        userName: $('#queryUserN').val(),
        email: $('#queryUserEmail').val(),
        payType: $('#queryPayType').val(),
        srId: $('#querySrId').val()
      };
    }

    /**
     * 工具：取得編輯欄位資料
     */
    function getDetailObj() {
      return {
        srRec: $('#inputSrRec').val(),
        loc: $('#inputLoc').val(),
        mood: $('#inputMood').val(),
        spcons: $('#inputSpcons').val()
      };
    }

    /**
     * 工具：填充詳細資料
     */
    function fillDetail(data) {
      $('#inputSrRec').val(data.srRec || "");
      $('#inputLoc').val(data.loc || "清醒");
      $('#inputMood').val(data.mood || "穩定");
      $('#inputSpcons').val(data.spcons || "無");
    }

    /**
     * 工具：清空詳細資料
     */
    function clearDetail() {
      $('#inputSrRec').val("");
      $('#inputLoc').val("清醒");
      $('#inputMood').val("穩定");
      $('#inputSpcons').val("無");
    }

    /**
     * 工具：填充查詢標籤
     */
    function fillQueryLabel(formObj) {
      const labelText = `${formObj.date}|${formObj.SRTimes} | ${formObj.userName} | ${formObj.custName} | ${formObj.payType} | ${formObj.srId}`;
      $('#labQuery').text(labelText);
    }

    /**
     * 返回查詢頁面
     */
    function backToSearch() {
      $('#detailSection').fadeOut();
      $('#searchSection').fadeIn();
    }

    // --- 剪貼簿與 UI 工具函數 (保持原樣) ---

    async function handleClipboard(action, targetId) {
      const $el = $(targetId);
      const text = $el.val();
      const srid = GLOBAL_DATA.ltcCodes.find(x => String(x.id) === $('#querySrId').val().trim());
      try {
        if (action === 'cut') {
          if (!text) return showToast('info', '沒有內容可以剪下');
          await navigator.clipboard.writeText(text);
          $el.val("");
          showToast('success', '已剪下');

        } else if (action === 'copy') {
          if (!text) return showToast('info', '內容為空，無法複製');
          await navigator.clipboard.writeText(text);
          showToast('success', '已複製');

        } else if (action === 'paste') {
          const clipboardText = await navigator.clipboard.readText();
          if (!clipboardText) return showToast('info', '剪貼簿中沒有內容');
          const currentVal = $el.val();
          $el.val(currentVal + clipboardText);
          showToast('success', '已貼上');
        } else if (action === 'addAI') {
          const currentVal = $el.val();
          $el.val(`${currentVal}\n修飾以上句子，符合長照 ${srid.id}${srid.cont} 電子服務紀錄單的格式，50個字以內，內容不包含長照編碼。`);
          showToast('success', '已加入AI助手');
        }
      } catch (err) {
        console.error('剪貼簿操作失敗:', err);
        Swal.fire({
          icon: 'error',
          title: '操作失敗',
          text: '請確保使用 HTTPS 並授權瀏覽器存取剪貼簿。',
          confirmButtonColor: '#dc3545'
        });
      }
    }

    function showToast(icon, title) {
      Swal.fire({
        icon: icon,
        title: title,
        timer: 1000,
        showConfirmButton: false,
        toast: true,
        position: 'top-end'
      });
    }

  </script>
</body>

<?!= includeFooter(); ?>

</html>