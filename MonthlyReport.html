<!doctype html>
<html>
  <head>
    <base target="_top" />
    <title>舒漾電子紀錄單管理系統</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css"
    />

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <style>
      /* 沿用 TranferResponse.html 的風格 */
      body {
        background-color: #f8f9fa;
        font-family: "Microsoft JhengHei", Arial, sans-serif;
      }

      .main-container {
        max-width: 800px;
        margin: 40px auto;
        /* 增加頂部距離 */
        padding: 30px;
        background-color: #ffffff;
        border-radius: 15px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
      }

      .header-title {
        color: #0d6efd;
        font-weight: bold;
        margin-bottom: 30px;
        text-align: center;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 15px;
      }

      .form-label {
        font-weight: 600;
        color: #495057;
      }

      .menu-btn {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 1000;
        box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
      }

      /* 優化選單內的項目間距 */
      .form-group {
        margin-bottom: 20px;
      }
    </style>
  </head>

  <body>
    <nav class="navbar navbar-dark bg-secondary sticky-top">
      <div class="container-fluid">
        <button
          class="btn btn-light text-secondary"
          type="button"
          data-bs-toggle="offcanvas"
          data-bs-target="#offcanvasNavbar"
        >
          <i class="fas fa-bars"></i>
        </button>
        <span class="navbar-brand mb-0 h1 mx-auto">舒漾月報表查詢系統</span>
      </div>
    </nav>

    <div
      class="offcanvas offcanvas-start"
      tabindex="-1"
      id="offcanvasNavbar"
      aria-labelledby="offcanvasNavbarLabel"
    >
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvasNavbarLabel">系統導航</h5>
        <button
          type="button"
          class="btn-close text-reset"
          data-bs-dismiss="offcanvas"
          aria-label="Close"
        ></button>
      </div>

      <div class="offcanvas-body"><?!= includeNav(); ?></div>
    </div>

    <div class="container">
      <div class="main-container">
        <h2 class="header-title">
          <i class="fas fa-file-medical-alt me-2"></i>舒漾月報表查詢系統
        </h2>

        <form id="reportForm" onsubmit="return false;">
          <div class="form-group">
            <label for="qrymonth" class="form-label">
              <i class="far fa-calendar-alt me-1"></i> 查詢月份
            </label>
            <select id="qrymonth" class="form-select form-select-lg" required>
              <option value="" disabled selected>請選擇月份</option>
            </select>
          </div>

          <div class="form-group">
            <label for="qrycust" class="form-label">
              <i class="fas fa-user-injured me-1"></i> 個案姓名
            </label>
            <select id="qrycust" class="form-select form-select-lg" required>
              <option value="" disabled selected>載入中...</option>
            </select>
          </div>

          <div class="form-group mb-4">
            <div class="form-check form-switch">
              <input
                class="form-check-input"
                type="checkbox"
                id="chkRegen"
                style="cursor: pointer"
              />
              <label
                class="form-check-label"
                for="chkRegen"
                style="cursor: pointer"
              >
                強制重新生成報表 (覆寫舊資料)
              </label>
            </div>
          </div>
          <div class="row g-4">
            <div class="d-grid gap-2 col-6">
              <button id="btnReport" class="btn btn-primary btn-lg shadow-sm">
                <i class="fas fa-search me-2"></i>查詢 / 產生報表
              </button>
            </div>

            <div class="d-grid gap-2 col-6">
              <button
                id="btnGenPdf"
                class="btn btn-info btn-lg text-dark shadow-sm"
              >
                <i class="fas fa-file-pdf me-2"></i>查詢 / 產生Pdf
              </button>
            </div>
          </div>

          <div id="progressArea" class="mt-4" style="display: none">
            <div class="d-flex justify-content-between mb-1">
              <span id="progressLabel" class="text-muted small"
                >準備處理...</span
              >
              <span id="progressPercent" class="text-primary fw-bold small"
                >0%</span
              >
            </div>
            <div class="progress" style="height: 20px">
              <div
                id="progressBar"
                class="progress-bar progress-bar-striped progress-bar-animated"
                role="progressbar"
                style="width: 0%"
              ></div>
            </div>
            <p
              id="currentTask"
              class="text-center mt-2 text-secondary small"
            ></p>
          </div>
        </form>
      </div>
    </div>

    <script>
      $(document).ready(function () {
        // 1. 初始化月份選單
        initMonthSelect();

        // 2. 初始化個案選單 (Session 機制)
        initCustSelect();

        // 3. 綁定按鈕事件
        $("#btnReport").click(handleReportGeneration);
        $("#btnGenPdf").click(handlePdfGeneration);
      });

      // --- 核心邏輯 ---

      function handleReportGeneration() {
        var yearmonth = $("#qrymonth").val();
        var custn = $("#qrycust").val();
        var regen = $("#chkRegen").prop("checked");
        // console.log("強制重新生成報表:", regen);
        if (!yearmonth || !custn) {
          Swal.fire("提示", "請選擇月份與個案", "warning");
          return;
        }

        // 初始化 UI
        $("#progressArea").fadeIn();
        updateProgressBar(0, 100, "啟動中...");
        $("#btnReport").prop("disabled", true); // 禁用按鈕防止重複點擊

        callGenReport(yearmonth, custn, regen);
      }

      function handlePdfGeneration() {
        var yearmonth = $("#qrymonth").val();
        var custn = $("#qrycust").val();
        var regen = $("#chkRegen").prop("checked");
        // console.log("強制重新生成報表:", regen);
        if (!yearmonth || !custn) {
          Swal.fire("提示", "請選擇月份與個案", "warning");
          return;
        }

        // 初始化 UI
        $("#progressArea").fadeIn();
        updateProgressBar(0, 100, "啟動中...");
        $("#btnGenPdf").prop("disabled", true); // 禁用按鈕防止重複點擊

        callGenPdf(yearmonth, custn, regen);
      }

      function initMonthSelect() {
        var startYear = 2026;
        var startMonth = 1;
        var now = new Date();
        var currentYear = now.getFullYear();
        var currentMonth = now.getMonth() + 1;

        // 關鍵修改：將結束月份設為「上個月」
        var targetEndYear = currentYear;
        var targetEndMonth = currentMonth - 1;

        // 如果現在是 1 月，上個月就是去年的 12 月
        if (targetEndMonth === 0) {
          targetEndYear = currentYear - 1;
          targetEndMonth = 12;
        }

        var $select = $("#qrymonth");
        $select.empty(); // 清空現有選項

        for (var y = targetEndYear; y >= startYear; y--) {
          var mStart = y === startYear ? startMonth : 1;
          var mEnd = y === targetEndYear ? targetEndMonth : 12;

          for (var m = mEnd; m >= mStart; m--) {
            var val = y.toString() + (m < 10 ? "0" + m : m);
            var text = y + "年 " + m + "月";
            $select.append($("<option>", { value: val, text: text }));
          }
        }
      }

      function initCustSelect() {
        var sessionCust = sessionStorage.getItem("RpCustN");
        var $select = $("#qrycust");

        if (sessionCust) {
          populateCustSelect(JSON.parse(sessionCust));
        } else {
          // 讀取中狀態
          $select.html("<option disabled selected>資料讀取中...</option>");

          google.script.run
            .withSuccessHandler(function (custArgs) {
              var list = ["all"].concat(custArgs);
              sessionStorage.setItem("RpCustN", JSON.stringify(list));

              $select.empty(); // 清除 "讀取中..."
              $select.append(
                '<option value="" disabled selected>請選擇個案名稱</option>',
              );
              populateCustSelect(list);
            })
            .withFailureHandler(function (err) {
              $select.html("<option disabled selected>讀取失敗</option>");
              Swal.fire("錯誤", "無法讀取個案清單: " + err.message, "error");
            })
            .getCustN();
        }
      }

      function populateCustSelect(list) {
        var $select = $("#qrycust");
        list.forEach(function (item) {
          var displayText = item === "all" ? "全部產生 (All Users)" : item;
          $select.append($("<option>", { value: item, text: displayText }));
        });
      }

      // 建立一個可以遞迴呼叫的函式
      function callGenReport(yearmonth, custn, regen) {
        google.script.run
          .withSuccessHandler(function (res) {
            if (res.status === "continue") {
              // 計算並更新百分比
              var percent = Math.round((res.currentIndex / res.total) * 100);
              updateProgressBar(res.currentIndex, res.total, res.message);

              // 繼續下一回合
              callGenReport(yearmonth, custn, regen);
            } else if (res.status === "complete") {
              // 完成
              updateProgressBar(100, 100, "全部處理完成！");
              $("#btnReport").prop("disabled", false);

              Swal.fire({
                icon: "success",
                title: "處理完成",
                text: res.message,
                confirmButtonText: res.btntext ,
                showCloseButton: true,
              }).then((result) => {
                if (result.isConfirmed && res.url) {
                  window.open(res.url, "_blank");
                }
                $("#progressArea").fadeOut();
              });
            }
          })
          .withFailureHandler(function (err) {
            $("#btnReport").prop("disabled", false);
            Swal.fire("系統錯誤", err.message, "error");
          })
          .genreport(yearmonth, custn, regen);
      }

      function callGenPdf(yearmonth, custn, regen) {
        google.script.run
          .withSuccessHandler(function (res) {
            if (res.status === "continue") {
              // 計算並更新百分比
              var percent = Math.round((res.currentIndex / res.total) * 100);
              updateProgressBar(res.currentIndex, res.total, res.message);

              // 繼續下一回合
              callGenReport(yearmonth, custn, regen);
            } else if (res.status === "complete") {
              // 完成
              updateProgressBar(100, 100, "全部處理完成！");
              $("#btnGenPdf").prop("disabled", false);

              Swal.fire({
                icon: "success",
                title: "處理完成",
                text: res.message,
                confirmButtonText: "查看Pdf",
                showCloseButton: true,
              }).then((result) => {
                if (result.isConfirmed && res.url) {
                  window.open(res.url, "_blank");
                }
                $("#progressArea").fadeOut();
              });
            }
          })
          .withFailureHandler(function (err) {
            $("#btnGenPdf").prop("disabled", false);
            Swal.fire("系統錯誤", err.message, "error");
          })
          .genPdfFile(yearmonth, custn, regen);
      }

      function updateLoadingMsg(msg) {
        Swal.update({ text: msg });
      }

      /**
       * 更新進度條 UI 的工具
       */
      function updateProgressBar(current, total, msg) {
        var percent = Math.round((current / total) * 100);

        // 增加一點動畫平滑感
        $("#progressBar").css({
          width: percent + "%",
          transition: "width 0.5s ease-in-out",
        });

        $("#progressPercent").text(percent + "%");
        $("#progressLabel").text(
          "已完成: " + current + " / " + total + " 位個案",
        );

        // 這裡會顯示「正在處理：王小明 (5/72)」
        $("#currentTask").html(
          '<i class="fas fa-spinner fa-spin me-2"></i>' + msg,
        );
      }
    </script>
  </body>
</html>
