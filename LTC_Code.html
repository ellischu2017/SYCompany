<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <title>長照編碼管理</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body {
      background-color: #f8f9fa;
      font-family: "Microsoft JhengHei", sans-serif;
    }

    .container {
      max-width: 600px;
      margin-top: 20px;
    }

    .hidden-section {
      display: none;
    }

    .code-label {
      font-weight: bold;
      font-size: 1.2rem;
      color: #0dcaf0;
      padding: 5px 0;
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      z-index: 9999;
      display: none;
      justify-content: center;
      align-items: center;
    }
  </style>
</head>

<body>

  <div id="loading" class="loading-overlay">
    <div class="spinner-border text-info" role="status"></div>
  </div>

  <nav class="navbar navbar-dark bg-info sticky-top">
    <div class="container-fluid">
      <button class="btn btn-light text-info" type="button" data-bs-toggle="offcanvas"
        data-bs-target="#offcanvasNavbar">
        <i class="fas fa-bars"></i>
      </button>
      <span class="navbar-brand mb-0 h1 mx-auto">長照編碼管理系統</span>
    </div>
  </nav>

  <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasNavbar">
    <div class="offcanvas-header">
      <h5>系統導航</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
      <?!= includeNav(); ?>
    </div>
  </div>

  <div class="container">
    <div id="searchSection" class="card shadow-sm mb-4">
      <div class="card-body">
        <h5 class="card-title">服務編碼選擇 (SR_ID)</h5>
        <div class="mb-3">
          <select class="form-select" id="selectSrId">
            <option value="" disabled selected>載入中...</option>
          </select>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-primary flex-grow-1" id="btnQuery">查詢</button>
          <button class="btn btn-success flex-grow-1" id="btnAddInit">新增</button>
        </div>
      </div>
    </div>

    <div id="detailSection" class="card shadow-sm hidden-section">
      <div class="card-body">
        <form id="ltcForm">
          <input type="hidden" id="formMode" value="update">

          <div class="mb-3">
            <label class="form-label">服務編碼 (SR_ID)</label>
            <div id="displaySrId" class="code-label"></div>
            <input type="hidden" id="inputSrId">
          </div>

          <div class="mb-3">
            <label class="form-label">服務項目名稱 (SR_Name)</label>
            <textarea class="form-control" id="inputSrName" rows="5" placeholder="例如：家務及日常生活照顧服務"></textarea>
          </div>

          <div class="mb-3">
            <label for="inputSrDetail" class="form-label">服務內容詳細說明 (SR_Detail)</label>
            <textarea class="form-control" id="inputSrDetail" rows="10" placeholder="請輸入詳細服務內容..."></textarea>
          </div>

          <div class="d-grid gap-2 mt-4">
            <button type="button" class="btn btn-info text-white" id="btnSave">更新資料</button>
            <button type="button" class="btn btn-danger" id="btnDelete">刪除</button>
            <button type="button" class="btn btn-secondary" onclick="backToSearch()">返回搜尋</button>
          </div>
        </form>
      </div>
    </div>
    <div class="container mt-2 text-end">
      <small class="text-muted">
        <i class="fas fa-user-circle"></i> 當前管理員：
        <?= userEmail ?>
      </small>
    </div>

  </div>

  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    $(document).ready(function () {
      loadDropdown();

      // 查詢
      $('#btnQuery').click(function () {
        const srId = $('#selectSrId').val();
        if (!srId) return Swal.fire('提示', '請選擇服務編碼', 'warning');
        $('#loading').show();
        google.script.run.withSuccessHandler(function (res) {
          $('#loading').hide();
          if (res.found) {
            $('#displaySrId').text(res.rowResult.SR_ID);
            $('#inputSrId').val(res.rowResult.SR_ID);
            $('#inputSrName').val(res.rowResult.SR_Name);
            $('#inputSrDetail').val(res.rowResult.SR_Detail); // 填入詳細說明
            switchToDetailMode('update');
          }
        }).queryLtcCodeData(srId);
      });

      // 新增初始
      $('#btnAddInit').click(function () {
        Swal.fire({
          title: '輸入新服務編碼 (SR_ID)',
          text: '例如：BA01',
          input: 'text',
          showCancelButton: true
        }).then((result) => {
          if (result.isConfirmed && result.value) {
            $('#ltcForm')[0].reset();
            $('#displaySrId').text(result.value);
            $('#inputSrId').val(result.value);
            switchToDetailMode('add');
          }
        });
      });

      // 儲存與更新
      $('#btnSave').click(function () {
        const mode = $('#formMode').val();
        const data = {
          srId: $('#inputSrId').val(),
          srName: $('#inputSrName').val(),
          srDetail: $('#inputSrDetail').val() // 抓取詳細說明內容
        };
        if (!data.srName) return Swal.fire('提示', '請輸入服務項目名稱', 'warning');

        $('#loading').show();
        const action = (mode === 'add') ? 'addLtcCodeData' : 'updateLtcCodeData';

        google.script.run.withSuccessHandler(function (res) {
          $('#loading').hide();
          if (res.success) {
            Swal.fire('成功', res.message, 'success').then(() => {
              if (mode === 'add') backToSearch();
              else backToSearch();
            });
          } else {
            Swal.fire('失敗', res.message, 'error');
          }
        })[action](data);
      });

      // 刪除
      $('#btnDelete').click(function () {
        const srId = $('#inputSrId').val();
        Swal.fire({
          title: '確定要刪除此編碼?',
          text: "此動作無法復原！",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33'
        }).then((result) => {
          if (result.isConfirmed) {
            $('#loading').show();
            google.script.run.withSuccessHandler(function (res) {
              $('#loading').hide();
              Swal.fire('已刪除', res.message, 'success').then(() => backToSearch());
            }).deleteLtcCodeData(srId);
          }
        });
      });
    });

    function loadDropdown() {
      google.script.run.withSuccessHandler(function (list) {
        const select = $('#selectSrId');
        select.empty().append('<option value="" disabled selected>請選擇服務編碼...</option>');
        list.forEach(id => select.append(`<option value="${id}">${id}</option>`));
      }).getLtcCodeList();
    }

    function switchToDetailMode(mode) {
      $('#searchSection').hide();
      $('#detailSection').show();
      $('#formMode').val(mode);
      $('#btnSave').text(mode === 'add' ? '確認新增' : '更新資料');
      if (mode === 'add') $('#btnDelete').hide(); else $('#btnDelete').show();
    }

    function backToSearch() {
      $('#detailSection').hide();
      $('#searchSection').show();
      loadDropdown();
    }

    // 1. 修改查詢成功後的填入邏輯
    function populateForm(data) {
      $('#displaySrId').text(data.SR_ID);
      $('#inputSrId').val(data.SR_ID);
      $('#inputSrName').val(data.SR_Name);
      $('#inputSrDetail').val(data.SR_Detail); // 填入詳細說明
    }

    // 3. 修改清空表單邏輯
    function clearForm() {
      $('#ltcForm')[0].reset();
      $('#inputSrDetail').val(''); // 確保 textarea 也被清空
    }

    /**
    * 呼叫後端同步權限功能
    */
    function syncPermissions() {
      // 檢查 Swal 是否存在，避免再次報錯
      if (typeof Swal === 'undefined') {
        alert("系統錯誤：尚未載入 SweetAlert2 函式庫");
        return;
      }

      // 1. 關閉 Offcanvas 導覽列
      var offcanvasElement = document.querySelector('.offcanvas');
      if (offcanvasElement) {
        var offcanvas = bootstrap.Offcanvas.getInstance(offcanvasElement);
        if (offcanvas) offcanvas.hide();
      }

      // 2. 啟動 SweetAlert2 動態效果
      Swal.fire({
        title: '同步權限中',
        text: '正在更新所有試算表權限，並清理名單，請稍候...',
        allowOutsideClick: false,
        showConfirmButton: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      // 3. 呼叫 GAS 後端
      google.script.run
        .withSuccessHandler(function () {
          Swal.fire({
            icon: 'success',
            title: '同步完成',
            text: '權限已成功更新',
            timer: 2000
          });
        })
        .withFailureHandler(function (err) {
          Swal.fire({
            icon: 'error',
            title: '同步失敗',
            text: err.message
          });
        })
        .syncMasterTablePermissions();
    }
    function runManualMaintenance() {
      // 1. 關閉導航列
      var offcanvasElement = document.querySelector('.offcanvas');
      var bsOffcanvas = bootstrap.Offcanvas.getInstance(offcanvasElement);
      if (bsOffcanvas) bsOffcanvas.hide();

      // 2. 顯示讀取中
      Swal.fire({
        title: '資料處理中',
        text: '正在遷移過期紀錄並同步 User 名單，若有新年度檔案將自動設定權限...',
        allowOutsideClick: false,
        didOpen: () => { Swal.showLoading(); }
      });

      // 3. 呼叫後端函式
      google.script.run
        .withSuccessHandler(function () {
          Swal.fire('完成', '資料維護與 User 同步已執行完畢。', 'success');
        })
        .withFailureHandler(function (err) {
          Swal.fire('執行失敗', err.message, 'error');
        })
        .dailyMaintenanceJob(); // 執行剛才寫的後端主函式
    }   
  </script>
</body>
<?!= includeFooter(); ?>

</html>