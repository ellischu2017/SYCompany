<!DOCTYPE html>
<html>
  
  <head>
    <base target="_top">
    <title>舒漾長照服務紀錄單管理系統</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    /* 自定義樣式以優化手機體驗 */
    body {
      background-color: #f8f9fa;
      font-family: "Microsoft JhengHei", Arial, sans-serif;
    }

    .main-container {
      max-width: 600px;
      /* 手機優先，限制最大寬度 */
      margin: 20px auto;
      padding: 15px;
    }

    .menu-btn {
      height: 80px;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s;
    }

    .menu-btn:active {
      transform: scale(0.98);
    }

    .navbar-custom {
      background-color: #0d6efd;
      /* Bootstrap Primary Color */
      color: white;
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
  </style>
</head>

<body>
  <div id="loadingSpin" class="loading-overlay">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>
  <nav class="navbar navbar-custom sticky-top">
    <div class="container-fluid">
      <button class="btn btn-light" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar"
        aria-controls="offcanvasNavbar">
        <i class="fas fa-bars"></i>
      </button>
      <span class="navbar-brand mb-0 h1 text-white mx-auto">舒漾長照服務紀錄單管理系統</span>
    </div>
  </nav>

  <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasNavbar" aria-labelledby="offcanvasNavbarLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="offcanvasNavbarLabel">系統導航</h5>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>

    <div class="offcanvas-body">
      <?!= includeNav(); ?>
    </div>

  </div>

  <div class="container main-container">
    <div class="row g-4">

      <div class="col-12">
        <a href="<?!= getScriptUrl() ?>?page=Cust" class="btn btn-primary w-100 menu-btn rounded-pill">
          <i class="fas fa-user-injured me-2"></i> 個案管理系統
        </a>
      </div>

      <div class="col-12 col-md-6">
        <a href="<?!= getScriptUrl() ?>?page=User" class="btn btn-success w-100 menu-btn rounded-pill">
          <i class="fas fa-user-nurse me-2"></i> 居服員管理系統
        </a>
      </div>

      <div class="col-12 col-md-6">
        <a href="<?!= getScriptUrl() ?>?page=Manager" class="btn btn-success w-100 menu-btn rounded-pill">
          <i class="fas fa-user-nurse me-2"></i> 管理員管理系統
        </a>
      </div>

      <div class="col-6">
        <a href="<?!= getScriptUrl() ?>?page=LTC_Code" class="btn btn-info text-white w-100 menu-btn rounded-3"
          style="height: 60px; font-size: 1rem;">
          <i class="fas fa-list-ol me-2"></i> 長照編碼
        </a>
      </div>

      <div class="col-6">
        <a href="<?!= getScriptUrl() ?>?page=RecUrl" class="btn btn-info text-white w-100 menu-btn rounded-3"
          style="height: 60px; font-size: 1rem;">
          <i class="fas fa-link me-2"></i> 網址管理
        </a>
      </div>

      <div class="col-6">
        <a href="<?!= getScriptUrl() ?>?page=SR_server" class="btn btn-warning text-dark w-100 menu-btn rounded-3">
          <i class="fas fa-file-medical me-2"></i> 舒漾電子服務紀錄(管理端)
        </a>
      </div>
      <div class="col-6">
        <a href="<?!= getScriptUrl() ?>?page=SR_server01" class="btn btn-danger text-white w-100 menu-btn rounded-3"
          target="_blank">
          <i class="fas fa-file-medical me-2"></i> 舒漾電子服務紀錄(用戶端)
        </a>
      </div>
      <hr>
      <div class="col-6">
        <a href="<?!= getScriptUrl() ?>?page=TranferResponse"
          class="btn btn-secondary text-white w-100 menu-btn rounded-3">
          <i class="fas fa-truck-moving me-2"></i> 資料轉換系統
        </a>
      </div>

      <div class="col-6">
        <a href="<?!= getScriptUrl() ?>?page=MonthlyReport"
          class="btn btn-secondary text-white w-100 menu-btn rounded-3">
          <i class="fas fa-server me-2"></i> 月報表查詢系統
        </a>
    </div>
    <div class="container mt-2 text-end">
      <small class="text-muted">
        <i class="fas fa-user-circle"></i> 當前管理員：
        <?= userEmail ?>
      </small>
    </div>
  </div>




  <script>
    // 頁面加載完成後的初始化邏輯
    $(document).ready(function () {
      checkAuthContext();
      $('#loading').css('display', 'flex');
      console.log("舒漾長照系統 - Index 頁面載入完成");
      $('#loading').hide();
      // 檢查如果沒有 userEmail (代表繞過後端載入，雖然機率低)
      if (!"<?= userEmail ?>") {
        window.top.location.href = "<?= webAppUrl ?>";
      }
    });


    /**
     * 檢查 URL 參數，確保與 Google Session 同步
     */
    function checkAuthContext() {
      const urlParams = new URLSearchParams(window.location.search);
      const currentAuthUser = urlParams.get('authuser');

      // 如果網址沒有 authuser 參數，可以視需求決定是否補上，
      // 避免在多帳號環境下跳轉回預設的 0 號帳號
      if (currentAuthUser === null) {
        console.log("提示：當前網址未指定 authuser，建議由官方入口進入以確保權限正確。");
      }
    }

    /**
    * 呼叫後端同步權限功能
    */
    function syncPermissions() {
      // 檢查 Swal 是否存在，避免再次報錯
      if (typeof Swal === 'undefined') {
        alert("系統錯誤：尚未載入 SweetAlert2 函式庫");
        return;
      }

      // 1. 關閉 Offcanvas 導覽列
      var offcanvasElement = document.querySelector('.offcanvas');
      if (offcanvasElement) {
        var offcanvas = bootstrap.Offcanvas.getInstance(offcanvasElement);
        if (offcanvas) offcanvas.hide();
      }

      // 2. 啟動 SweetAlert2 動態效果
      Swal.fire({
        title: '同步權限中',
        text: '正在更新所有試算表權限，並清理名單，請稍候...',
        allowOutsideClick: false,
        showConfirmButton: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      // 3. 呼叫 GAS 後端
      google.script.run
        .withSuccessHandler(function () {
          Swal.fire({
            icon: 'success',
            title: '同步完成',
            text: '權限已成功更新',
            timer: 2000
          });
        })
        .withFailureHandler(function (err) {
          Swal.fire({
            icon: 'error',
            title: '同步失敗',
            text: err.message
          });
        })
        .syncMasterTablePermissions();
    }

    function runManualMaintenance() {
      // 1. 關閉導航列
      var offcanvasElement = document.querySelector('.offcanvas');
      var bsOffcanvas = bootstrap.Offcanvas.getInstance(offcanvasElement);
      if (bsOffcanvas) bsOffcanvas.hide();

      // 2. 顯示讀取中
      Swal.fire({
        title: '資料處理中',
        text: '正在遷移過期紀錄並同步 User 名單，若有新年度檔案將自動設定權限...',
        allowOutsideClick: false,
        didOpen: () => { Swal.showLoading(); }
      });

      // 3. 呼叫後端函式
      google.script.run
        .withSuccessHandler(function () {
          Swal.fire('完成', '資料維護與 User 同步已執行完畢。', 'success');
        })
        .withFailureHandler(function (err) {
          Swal.fire('執行失敗', err.message, 'error');
        })
        .dailyMaintenanceJob(); // 執行剛才寫的後端主函式
    }    
  </script>
</body>
<?!= includeFooter(); ?>

</html>